name: Cypress Tests with Report and Notification on TEAMS
 
on:
  schedule:
    - cron: "0 */6 * * *"  # 6hours 
  workflow_dispatch:
 
jobs:
  cypress-tests:
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
 
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
 
      - name: Install dependencies
        run: npm install
 
      - name: Install Cypress and reporter
        run: npm install cypress cypress-mochawesome-reporter
 
      - name: Run Cypress tests with Mochawesome
        env:
          CYPRESS_EMAIL: ${{ secrets.CYPRESS_EMAIL }}
          CYPRESS_PASSWORD: ${{ secrets.CYPRESS_PASSWORD }}
          CYPRESS_MOCHAWESOME_REPORT_DIR: cypress/reports  # Moved inside the `env` block
        run: |
          echo "Email: $CYPRESS_EMAIL"  # Debugging
          echo "Password: $CYPRESS_PASSWORD"  # Debugging
          npx cypress run --env email=$CYPRESS_EMAIL,password=$CYPRESS_PASSWORD --reporter mochawesome --reporter-options "reportDir=cypress/reports,overwrite=false,html=true,json=true"
 
      - name: Debug - Check Reports Directory
        run: ls -R cypress/reports || echo "No reports generated"
 
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-report
          path: cypress/reports/
          if-no-files-found: warn  # Prevents workflow failure if no reports exist
 
      - name: Send notification to Microsoft Teams
        if: always()  # Ensures notification is sent even if tests fail
        run: |
          STATUS="✅ IR Daily Health Check tests passed !"
          if [ "${{ job.status }}" != 'success' ]; then STATUS="❌ IR Daily Health Check tests failed !"; fi
          curl -H "Content-Type: application/json" -d '{
            "title": "IR Daily Health Check Test Results",
            "text": "'"$STATUS"'\n[Cypress Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})",
            "themeColor": "'"${{ job.status == 'success' && '0076D7' || 'FF0000' }}"'"
          }' $TEAMS_WEBHOOK_URL
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
